<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Firma con MetaMask</title>
</head>
<body>
  <h2>Conferma la firma con MetaMask</h2>
  <button onclick="firma()">Firma Messaggio</button>

<script>
  async function firma() {
    if (typeof window.ethereum === 'undefined') {
      alert("⚠️ MetaMask non è installato.");
      return;
    }

    const message = "Autenticazione SupplyChain";
    const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
    const address = accounts[0];

    const hexMessage = '0x' + [...message].map(c =>
      c.charCodeAt(0).toString(16).padStart(2, '0')).join('');

    const signature = await ethereum.request({
      method: 'personal_sign',
      params: [hexMessage, address],
    });

    const urlParams = new URLSearchParams(window.location.search);
    const nome = urlParams.get("nome");
    const tipo = urlParams.get("tipo");
    const indirizzo = urlParams.get("indirizzo");
    const username = urlParams.get("username");
    const password = urlParams.get("password");

    const res = await fetch("http://localhost:5000/verifica", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message,
        address,
        signature,
        nome,
        tipo,
        indirizzo,
        username,
        password
      })
    });

    const json = await res.json();
    alert(json.message);  // Mostra l’esito

    // Dopo conferma alert → chiudi la finestra
    window.close();
  }

  // Esegui automaticamente all’apertura della pagina
  window.onload = firma;
</script>


</body>
</html>
